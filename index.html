<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>轉盤打怪小遊戲</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            color: white;
            background: url('images/background.jpg') no-repeat center center fixed;
            background-size: cover;
        }
        
		    #selectionGif {
                          text-align: center;
                          margin-bottom: 20px;
                          }

            #selectionGif img {
                          width: 300px; /* 可根據需求調整大小 */
                          height: auto;
                          border-radius: 10px;
                              }

        .monster { 
            margin: 10px; padding: 10px; border: 2px solid white; cursor: pointer; display: inline-block; 
            background: rgba(0, 0, 0, 0.5); 
        }

        .spin-result {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 24px;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
            margin-top: 20px;
            position: relative;
            min-width: 150px;
        }

        #gameArea, #lootArea { display: none; }

        img { width: 200px; display: block; margin: 0 auto; }

        .health-bar-container {
            width: 300px;
            background-color: #333;
            border-radius: 10px;
            margin: 10px auto;
            overflow: hidden;
            border: 2px solid white;
        }

        .health-bar {
            height: 20px;
            background-color: red;
            transition: width 0.5s ease-in-out;
        }

        #damageTaken {
            display: block;
            margin-top: 10px;
            font-size: 20px;
            color: yellow;
        }

        .damage-input-container {
            margin-top: 20px;
        }
		#skillButton {
                     font-size: 24px;
                     padding: 15px 30px;
                     margin-top: 20px;
                     background-color: orangered;
                     color: white;
                     border: none;
                     border-radius: 10px;
                     cursor: pointer;
                     display: block;
                     width: 80%;
                     max-width: 400px;
                     margin: 20px auto;
                     }

        #skillButton:active {
                     background-color: darkred;
                            }
	#attackButton {

    width: 100px; /* 調整大小 */
    height: auto;
    cursor: pointer; /* 讓滑鼠變成點擊手勢 */
    transition: transform 0.1s ease-in-out;
}

#attackButton:active {
    transform: scale(0.9); /* 點擊時縮小一點，增加打擊感 */
}

#spinButton {
    width: 120px; /* 調整大小 */
    height: auto;
    cursor: pointer; /* 讓滑鼠變成點擊手勢 */
    transition: transform 0.1s ease-in-out;
}

#spinButton:active {
    transform: scale(0.9); /* 點擊時縮小一點，增加手感 */
}

.icon {
    width: 30px;  /* 調整大小 */
    height: auto;
    vertical-align: middle;  /* 讓圖片跟文字對齊 */
}

.spin-result {
    width: 200px; /* 固定大小 */
    height: 50px; /* 固定高度 */
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 8px;
    font-size: 24px;
    font-weight: bold;
    color: white;
}

.spin-result img {
    max-width: 40px; /* 限制圖片大小 */
    max-height: 40px;
    vertical-align: middle; /* 圖片垂直置中 */
}
.spin-container {
    display: flex;
    align-items: center;  /* 垂直置中 */
    justify-content: center; /* 水平置中 */
    gap: 20px; /* 控制間距 */
    margin-top: 20px;

     width: fit-content; /* 讓容器寬度剛好適應內容 */
    margin: 0 auto; /* 讓它水平置中 */
}
#spinButton img {
    width: 80px;  /* 按鈕圖片大小 */
    height: auto;
    cursor: pointer;
}

.monster-container {
    width: 250px;  /* 固定怪物顯示框的寬度 */
    height: 250px; /* 固定高度，確保圖片不影響版面 */
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden; /* 避免溢出 */
    margin: 0 auto; /* 讓它置中 */
}

#monsterImage {
    width: 200px; /* 設定固定寬度 */
    height: 200px; /* 設定固定高度，確保不變形 */
    object-fit: contain; /* 確保圖片完整顯示，不拉伸變形 */
	z-index: 10; /* 比傷害數字低 */
}

#damageTaken {
    display: inline-block;
    width: 100px;  /* 固定寬度，根據最大傷害數字調整 */
    text-align: center; /* 確保數字居中 */
    font-size: 20px;
    color: yellow;
}

#damageContainer {
    position: relative;
    width: 100%;
    height: 0;
	z-index: 1000; /* 必須高於怪物 */
}

.damage-number {
    position: absolute;
    font-size: 28px;
    font-weight: bold;
    color: yellow;
    opacity: 1;
    transform: scale(1);
    transition: transform 1s ease-out, opacity 1s ease-out;
    white-space: nowrap;
    pointer-events: none;
	z-index: 9999; /* 提高層級 */
}

.damage-number.animate {
    opacity: 1;
    transform: scale(1.5);
    top: -30px;  /* 讓數字往上移動 */
}

#inventory {
    position: fixed;
    bottom: 10px; /* 距離畫面底部 10px */
    left: 50%;
    transform: translateX(-50%); /* 水平置中 */
    display: flex;
    gap: 5px;
    padding: 10px;
    background: rgba(0, 0, 0, 0.8);
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
}

#inventorySlots {
    display: flex;
    justify-content: center; /* 水平置中 */
    align-items: center; /* 垂直置中（如果有高度限制） */
    gap: 5px;
}

.inventory-slot {
     width: 50px;
    height: 50px;
    background-size: cover;
    background-position: center;
    border: 2px solid white;
    position: relative; /* 讓 z-index 生效 */
    z-index: 10; /* 確保不被其他元素覆蓋 */
}

#itemGrid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: 5px;
    width: 290px;
    height: auto;
    padding: 10px;
    background-color: rgba(0, 0, 0, 0.5);
    border: 2px solid white;

    /* 中間偏下位置 */
    margin: 20px auto 40px auto; /* 上、左右、下 */
}

.item {
    width: 50px;
    height: 50px;
    background-size: cover;
    background-position: center;
    cursor: pointer;
    border: 2px solid white; /* 每個道具格子加邊框 */
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.2);
}

.item:hover {
    background-color: #ddd;
}



    </style>
</head>
<body>
    <h1>選擇怪物</h1>
	
	 <!-- 加入 GIF 動畫 -->
    <div id="selectionGif">
        <img src="images/selection.gif" alt="選擇怪物動畫">
    </div>
	
    <div id="monsterSelection">
        <div class="monster" data-hp="50" data-img="images/monster1.png" data-dead="images/monster1_dead.png" data-drop="gold.png">怪物A (50HP)</div>
        <div class="monster" data-hp="100" data-img="images/monster2.png" data-dead="images/monster2_dead.png" data-drop="gem.png">怪物B (100HP)</div>
        <div class="monster" data-hp="150" data-img="images/monster3.png" data-dead="images/monster3_dead.png" data-drop="sword.png">怪物C (150HP)</div>
        <div class="monster" data-hp="200" data-img="images/monster4.png" data-dead="images/monster4_dead.png" data-drop="helmet.png">怪物D (200HP)</div>
    </div>
	
	<div id="menu">
    <h2>選擇道具</h2>
    
    <!-- 道具欄（最多 10 個） -->
    <div id="inventory">
        <h3>📦 道具欄</h3>
        <div id="inventorySlots">
            <!-- 這裡會動態填充道具 -->
        </div>
    </div>

    <!-- 道具選擇區 -->
    <div id="itemSelection">
        <h3>🎒 道具選擇</h3>
        <div id="itemGrid">
            <!-- 這裡會動態填充 5x5 的道具 -->
        </div>
    </div>
    </div>

    <div id="gameArea">

        <h2>怪物血量: <span id="monsterHp"></span></h2>
        <div class="health-bar-container">
            <div id="healthBar" class="health-bar"></div>
        </div>
	<div id="damageContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
	
	<div id="monsterContainer" style="position: relative; display: inline-block;">
    <img id="monsterImage" src="monster_alive.png">
   
</div>
        <p id="damageTaken"></p>
		<div class="spin-container">
		
              <div id="spinResult" class="spin-result"></div>
			  
		<!-- 轉盤按鈕 --> 
        <img src="images/spin_wheel.png" id="spinButton" onclick="spinWheel()" alt="開始轉盤" title="開始轉盤">
		
		      </div>
        <br><br>
		
        <div class="damage-input-container">
            <label for="damageInput">輸入傷害數字：</label>
            <input type="number" id="damageInput" min="1" value="0">
            <img src="images/Fire.png" id="attackButton" onclick="applyDamage()" alt="攻擊" title="攻擊">
        </div>
		
		<br>
		<!-- 技能按鈕 -->
		 <button id="skillButton" onclick="activateSkill()">技能: 快速點擊 (5秒)</button>
		 
    </div>

    <div id="lootArea">
        <h2>掉落物</h2>
        <div class="loot-container" id="lootContainer"></div>
        <button onclick="restartGame()">返回選擇怪物</button>
    </div>

<script>
    let currentMonsterHp = 0;
    let maxHp = 0;
    let drops = [];
    let deadImage = "";
	let hitSound = new Audio();
    let deadSound = new Audio();
    let spinSound = new Audio("sounds/spin_result.mp3");
	let clickCount = 0;
    let skillActive = false;
    let skillTimer;
	let spinCount = 0; // 轉盤次數
    let skillCooldown = 5; // 技能冷卻所需的轉盤次數
	



  document.querySelectorAll(".monster").forEach(monster => {
    monster.addEventListener("click", function() {
        let hp = parseInt(this.dataset.hp);
        let img = this.dataset.img;  // 活著的怪物圖
        let monsterIndex = [...this.parentElement.children].indexOf(this) + 1;

        deadImage = this.dataset.dead; // 死亡圖
        drops = this.dataset.drop.split(",");
        currentMonsterHp = hp;
        maxHp = hp;

        hitSound.src = `sounds/hit${monsterIndex}.mp3`;
        deadSound.src = `sounds/dead${monsterIndex}.mp3`;

        document.getElementById("monsterHp").textContent = hp;
        document.getElementById("damageTaken").textContent = "";
        document.getElementById("healthBar").style.width = "100%";
        document.getElementById("monsterImage").src = img;
        document.getElementById("monsterSelection").style.display = "none";
        document.getElementById("gameArea").style.display = "block";
        document.getElementById("lootArea").style.display = "none";
		document.getElementById("monsterImage").src = img; // 確保選擇怪物時顯示正確的圖片
		document.getElementById("itemSelection").style.display = "none";
		
		// 隱藏選擇 GIF
        document.getElementById("selectionGif").style.display = "none";
    });
});

const inventorySlots = document.getElementById("inventorySlots");
const itemGrid = document.getElementById("itemGrid");12

const items = [
    "item1.png", "item2.png", "shield.png", "magic_book.png", "arrow.png",
    "elixir.png", "bomb.png", "fireball.png", "ice_crystal.png", "thunder_scroll.png",
    "hp_up.png", "attack_up.png", "defense_up.png", "speed_boost.png", "revive.png",
    
];



// 生成道具欄（10格）
for (let i = 0; i < 10; i++) {
    let slot = document.createElement("div");
    slot.classList.add("inventory-slot");
    slot.dataset.index = i; // 紀錄索引
    inventorySlots.appendChild(slot);
}

document.querySelectorAll(".inventory-slot").forEach(slot => {
    slot.addEventListener("click", function () {
        if (slot.classList.contains("filled")) {
            let confirmDelete = confirm("確定要移除這個道具嗎？");
            if (confirmDelete) {
                slot.style.backgroundImage = ""; // 移除圖片
                slot.classList.remove("filled"); // 變回空格
                delete slot.dataset.item; // 清除道具資訊
            }
        }
    });
});

// 生成道具選擇區（5x5）
items.forEach((item, index) => {
    let itemElement = document.createElement("div");
    itemElement.classList.add("item");
    itemElement.dataset.item = item.replace(".png", "");
    itemElement.style.backgroundImage = `url(images/${item})`;

    // 點擊道具加入道具欄
    itemElement.addEventListener("click", function () {
        let emptySlot = document.querySelector(".inventory-slot:not(.filled)");
        if (emptySlot) {
            emptySlot.style.backgroundImage = `url(images/${item})`;
            emptySlot.classList.add("filled");
            emptySlot.dataset.item = item.replace(".png", "");
        }
    });

    itemGrid.appendChild(itemElement);
});

function hasItem(itemName) {
    return [...document.querySelectorAll(".inventory-slot")].some(slot => slot.dataset.item === itemName);
}
function startBattle() {
    document.getElementById("gameArea").style.display = "block";  // 顯示戰鬥畫面
    document.getElementById("monsterSelection").style.display = "none"; // 隱藏選單
    document.getElementById("lootArea").style.display = "none"; // 隱藏掉落物
    document.getElementById("inventory").style.display = "flex"; // 確保道具欄顯示
	document.getElementById("itemSelection").style.display = "none";
	document.getElementById("inventory").style.display = "flex";
	
 
    equippedItems = []; // 清空已裝備道具

    document.querySelectorAll(".inventory-slot").forEach(slot => {
        if (slot.dataset.item) { 
            equippedItems.push(slot.dataset.item);
            console.log(`✅ 已裝備: ${slot.dataset.item}`);
        }
    });

    updateSkillButton();

}

// 每次選擇新怪物後，重置道具欄
function resetInventory() {
    document.querySelectorAll(".inventory-slot").forEach(slot => {
        slot.style.backgroundImage = "";
        slot.classList.remove("filled");
        delete slot.dataset.item;
    });
}
function activateSkill() {
    if (skillActive || spinCount < skillCooldown) return; // 若技能冷卻則無法使用

    skillActive = true;
    clickCount = 0;
    spinCount = 0; // **技能冷卻重置**
    updateSkillButton();
    
    document.getElementById("skillButton").textContent = "🔥 快速點擊中! 🔥";
    document.getElementById("gameArea").addEventListener("click", countClicks);

    skillTimer = setTimeout(() => {
        document.getElementById("gameArea").removeEventListener("click", countClicks);
        document.getElementById("skillButton").textContent = `技能冷卻中 (${skillCooldown} 次轉盤)`;
        skillActive = false;
        updateSkillButton();
    }, 5000);
}

function countClicks() {
    if (skillActive) {
        clickCount++;
        let damage = -1; // 基礎傷害
        let damageType = "click"; // 標記為點擊傷害

        // 檢查是否持有技能強化道具 (item2)
        if (hasItem("item2")) {
            let chance = Math.random();
            if (chance < 0.2) { // 20% 機率
                console.log("💥【技能強化道具生效！】點擊傷害變為 2 點！");
                damage = -2;
                skipExtra = true; // 當技能效果生效時，不再應用轉盤額外扣血
            }
        }
		
        console.log(`🖱️ countClicks: 點擊傷害 ${damage}`);
        modifyHp(damage, damageType); // **傳遞 damageType = "click"**
        document.getElementById("damageTaken").textContent = `總傷害: ${clickCount}`;
        hitSound.currentTime = 0;
        hitSound.play();
    }
}



function hasItem(itemName) {
    return [...document.querySelectorAll(".inventory-slot")].some(slot => slot.dataset.item === itemName);
}

function modifyHp(amount, damageType) {
    console.log(`⚡ modifyHp() 被呼叫，傷害值: ${amount}, 傷害類型: ${damageType}`);

    const damageContainer = document.getElementById("damageContainer");
    const monsterHpElement = document.getElementById("monsterHp");
    const healthBar = document.getElementById("healthBar");

    if (!damageContainer || !monsterHpElement || !healthBar) {
        console.error("❌ Error: 必要的 UI 元素不存在！");
        return;
    }

    // **修正 item1 效果：只對轉盤的 -5、-10、-20 產生影響**
    if (damageType === "spin" && hasItem("item1") && (amount === -5 || amount === -10 || amount === -20)) {
        console.log(`🎯【轉盤強化道具生效】額外 +5 傷害，原傷害: ${amount}`);
        amount += 5; // 提高傷害值
    }

    // 更新血量（確保不超出範圍）
    currentMonsterHp = Math.max(0, Math.min(currentMonsterHp + amount, maxHp));
    monsterHpElement.textContent = currentMonsterHp;
    healthBar.style.width = `${(currentMonsterHp / maxHp) * 100}%`;

    // 怪物死亡處理
    if (currentMonsterHp <= 0) {
        handleMonsterDeath();
        return;
    }

    // 處理傷害動畫與音效
    if (amount !== 0) {
        displayDamageEffect(amount);
    }
}


function handleMonsterDeath() {
    const monsterImage = document.getElementById("monsterImage");
    const selectedMonster = document.querySelector(`.monster[data-img="${monsterImage.getAttribute("src")}"]`);
    
    if (selectedMonster) {
        let deadImg = selectedMonster.getAttribute("data-dead");
        console.log("💀 變更為死亡圖片:", deadImg);
        monsterImage.src = deadImg;
    } else {
        console.error("❌ 無法找到對應的死亡圖片！");
        monsterImage.src = `images/monster${currentMonsterType}_dead.png`;
    }

    monsterImage.style.opacity = "1";
    deadSound.play();

    setTimeout(() => {
        document.getElementById("gameArea").style.display = "none";
        document.getElementById("lootArea").style.display = "block";
        generateLoot();
    }, 3000);
}

function generateLoot() {
    const lootContainer = document.getElementById("lootContainer");
    let lootCount = Math.floor(Math.random() * 3) + 1;

    lootContainer.innerHTML = Array.from({ length: lootCount }, () =>
        `<img src='images/${drops[Math.floor(Math.random() * drops.length)]}'>`
    ).join('');
}

function displayDamageEffect(amount) {
    const damageContainer = document.getElementById("damageContainer");
    const monsterImage = document.getElementById("monsterImage");

    let damageText = document.createElement("div");
    damageText.classList.add("damage-number");
    damageText.textContent = Math.abs(amount);

    if (amount < 0) {
        hitSound.currentTime = 0;
        hitSound.play();
        shakeMonster(Math.abs(amount));
    }

    let monsterRect = monsterImage.getBoundingClientRect();
    let containerRect = damageContainer.getBoundingClientRect();
    let startX = monsterRect.left + monsterRect.width / 2 - containerRect.left;
    let startY = monsterRect.top + monsterRect.height / 3 - containerRect.top;
    
    damageText.style.left = `${startX}px`;
    damageText.style.top = `${startY}px`;
    damageContainer.appendChild(damageText);

    let randomAngle = Math.random() * 2 * Math.PI;
    let distance = Math.random() * 80 + 40;
    let offsetX = Math.cos(randomAngle) * distance;
    let offsetY = Math.sin(randomAngle) * distance;

    setTimeout(() => {
        damageText.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(1.5)`;
        damageText.style.opacity = "0";
    }, 10);

    setTimeout(() => {
        damageText.remove();
    }, 1500);
}


    

// **🌀 震動效果**
function shakeMonster(damage) {
    let monsterImage = document.getElementById("monsterImage");
	
    let intensity = Math.max(3, Math.min(5, damage / 10));
	// 📌 確保最小震動幅度為 3px，即使只有 -1 HP
    // 📌 傷害越大，震動越強（最大 5px）
    let duration = 300; // 震動時間

    monsterImage.style.transition = "transform 0.05s";
    let frames = [
        { transform: `translate(${intensity}px, 0px)` },
        { transform: `translate(-${intensity}px, 0px)` },
        { transform: `translate(${intensity}px, 0px)` },
        { transform: `translate(-${intensity}px, 0px)` },
        { transform: `translate(0px, 0px)` }
    ];

    monsterImage.animate(frames, { duration: duration, iterations: 1 });
}



function spinWheel() {
    let effects = [
        { text: '<img src="images/dice.png" class="icon"> +1', effect: () => modifyHp(0) },
        { text: '<img src="images/dice.png" class="icon"> -1', effect: () => modifyHp(0) },
        { text: '<img src="images/damage_x2.png" class="icon">', effect: () => applyDamageMultiplier(2) },
        { text: '<img src="images/damage_half.png" class="icon">', effect: () => applyDamageMultiplier(0.5) },
        { text: '<img src="images/heart.png" class="icon"> +5', effect: () => modifyHp(5) },
        { text: '<img src="images/heart.png" class="icon"> +10', effect: () => modifyHp(10) },
        { text: '<img src="images/heart.png" class="icon"> +20', effect: () => modifyHp(20) },
        { text: '<img src="images/heart.png" class="icon"> -5', effect: () => modifyHp(-5, "spin") },
        { text: '<img src="images/heart.png" class="icon"> -10', effect: () => modifyHp(-10, "spin") },
        { text: '<img src="images/heart.png" class="icon"> -20', effect: () => modifyHp(-20, "spin") }
    ];

    let spinResult = document.getElementById("spinResult");
    let intervalTime = 100; 
    let duration = 3000; 
    let elapsedTime = 0;

    let interval = setInterval(() => {
        let randomEffect = effects[Math.floor(Math.random() * effects.length)];
        spinResult.innerHTML = ` ${randomEffect.text}`;
        elapsedTime += intervalTime;

        if (elapsedTime >= duration) {2
            clearInterval(interval);
            let chosenEffect = effects[Math.floor(Math.random() * effects.length)];
            spinResult.innerHTML = ` ${chosenEffect.text}`;

            spinSound.play();
            if (chosenEffect.effect) chosenEffect.effect();
			// 累計一次轉盤轉動
            spinCount++;
            updateSkillButton();
        }
    }, intervalTime);
}1

// 確保 applyDamageMultiplier() 存在
function applyDamageMultiplier(multiplier) {
    let damage = parseInt(document.getElementById("damageInput").value) || 0;
    modifyHp(-damage * multiplier);
}


function updateSkillButton() {
    let skillButton = document.getElementById("skillButton");
    
    if (spinCount < skillCooldown) {
        skillButton.textContent = `技能冷卻中 (${skillCooldown - spinCount} 次轉盤)`;
        skillButton.disabled = true;
        skillButton.style.opacity = "0.5"; // 按鈕變灰
    } else {
        skillButton.textContent = "🔥 技能: 快速點擊 (5秒) 🔥";
        skillButton.disabled = false;
        skillButton.style.opacity = "1"; // 恢復按鈕
    }
}

// **在選擇怪物時重置技能冷卻**
document.querySelectorAll(".monster").forEach(monster => {
    monster.addEventListener("click", function() {
        // 讓技能可用
        spinCount = skillCooldown; // **確保開場可以使用技能**
        updateSkillButton();
    });
});

    function applyDamage() {
        let damage = parseInt(document.getElementById("damageInput").value) || 0;
        modifyHp(-damage);
    }

  
	

    function restartGame() {
        document.getElementById("gameArea").style.display = "none";
        document.getElementById("lootArea").style.display = "none";
        document.getElementById("monsterSelection").style.display = "block";
    }
</script>
</body>
</html>
